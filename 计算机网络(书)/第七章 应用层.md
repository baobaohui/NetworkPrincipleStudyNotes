# 第七章 应用层
## 7.1 Internet 应用与应用层协议的分类
### 7.1.1 Internet 应用技术发展的三个阶段
    
    第一阶段：提供远程登录，电子邮件，文件传输，电子公告牌与网络新闻组等基本的网络服务功能
    第二阶段：Web技术，以及基于Web技术的电子政务，电子商务，远程医疗与远程教育应用，搜索引擎技术
    第三阶段：P2P 网络应用
### 7.1.2 C/S模式与P2P模式的比较
1，客户/服务器模式的基本概念
    
    客户/服务器结构的特点
        C/S(client/server),客户/服务器模式
    采用客户/服务器模式的原因
        网络资源分布的不均匀性，表现在硬件，软件和数据三方面
    
2，对等网络的基本概念
    
    P2P 是网络结点之间采取对等的方式，通过直接交换信息达到共享计算机资源和服务的工作模式
    P2P 通信模式：P2P 网络中对等结点之间直接通信的能力
    P2P 网络 ：Internet 中由对等结点组成的一种动态的逻辑网络
    P2P 实现技术：为实现对等结点之间直接通信的功能和特定的应用所涉及的协议与软件
3，P2P与C/S工作模式的区别
    
    a，C/S 工作模式中信息资源的共享是以服务器为中心
    b，P2P 工作模式淡化服务提供者与服务使用者的界限
    c，C/S 与P2P模式的差别主要在于应用层
    d，P2P 网络是在IP网络上搭建的一种逻辑的覆盖网
    
### 7.1.3 应用层协议的分类
1，应用层协议的基本概念
    
    应用层协议规定了应用程序进程之间通信所遵循的通信规则，包括：如何构造进程通信的报文等
2，应用程序体系结构的概念
    
    将网络应用程序功能，工作模型与协议结构定义为应用程序体系结构
3，应用层协议的基本内容
    
    应用层协议定义了运行在不同端系统上应用程序进程交换的报文格式与交互过程
    
    交换报文的类型
    各种报文格式与包含的字段类型
    对每个字段意义的描述
    进程在什么时间，如何发送报文，以及如何响应
4，应用层协议的分类
    
    根据应用层协议在Internet 中的作用和提供的服务功能，应用层协议可以分为三种基本类型：
    
    基础设施类 DNS DHCP
    网络应用类 TELNET SMTP FTP HTTP等
    网络管理类 SNMP
    
详情见 图7.4 应用层协议分类

## 7.2 域名系统
### 7.2.1 DNS 研究的背景

    1，早期ARPANET主机的命名方法
    2，域名系统的基本概念
    3，DNS与其他网络应用的关系 
        将主机域名转换成IP地址，使得用户能够方便地访问各种Internet资源与服务，
        它是Internet各种应用层协议实现的基础
    4，DNS设计需要满足的基本要求
        实现下面三种功能：
            域名空间：定义一个包括所有可能出现的主机名字的域名空间
            域名注册：保证每台主机域名的唯一性
            域名解析：提供一种有效的域名与IP地址转换机制
        DNS 包括域名空间，域名服务器，域名解析程序三个组成部分
详情见 图7.5 DNS与其他网络应用的关系
    
### 7.2.2 DNS 域名空间
    
1，DNS域名空间的基本概念
        
    采用 域 - 子域 层次结构，DNS必须有一个大型的，分布式的域名数据库，
    来存储层次性的域名数据      
    
    域名空间的层次结构可以表示为树状结构
2，域名空间结构
        
    顶级域，二级域名，三级域名，四级域名
    
    Internet被分成200多个顶级域
    每个域自己控制如歌分配他下面的域
    为了创建一个新的域，创建者必须得到该新域的上级域管理员的许可
    域名机制遵循的是组织的边界，而不是网络的物理边界
### 7.2.3 域名服务器
1，区，域与域名服务器
    
    根据需要将一个 域 划分成不重叠的多个 区
    每个 区 设置相应的权限域名服务器，用来保存该区内的所有主机的域名与IP地址的映射关系数据
    区 和 区 的域名服务器都相互连接，构成支持整个域的域名服务器体系
2，域名服务器结构与分类
    
    根域名服务器
    顶级域名服务器
    权限域名服务器
    本地域名服务器
### 7.2.4 域名解析
1，域名解析的基本概念
    
    将域名转换为对应的IP地址的过程称为域名解析，完成该功能的软件称为域名解析器
2，域名解析算法
    
    递归解析
        在递归解析过程中，如果本地域名服务器没有需要解析的信息，那么本地域名服务器将接管
        向其他域名服务器请求解析的责任，只将最终结果返回给客户
        
    反复解析
        也称为迭代解析。指本地域名服务器如果不能够返回最终的解析结果，那么他只能返回他认为可以
        解析的域名服务器的IP地址。客户端解析程序就向下一个域名服务器发出解析请求，直至最终
        获得需要的解析结果。
### 7.2.5 域名系统性能优化
1，复制
    
    每个根服务器的许多副本存在整个网络上。当一个新的子网加入时，它在本地DNS服务器中配置一个根服务器表
2，缓存
    
    使用名字的高速缓存可优化查询的开销
## 7.3 远程登录服务与 TELNET 协议
### 7.3.1 TELNET 协议产生的背景
    
    解决不同型号计算机之间的差异性问题
    引入网络虚拟终端概念
### 7.3.2 TELNET 协议基本工作原理
    
    示意图如下：
            主机系统内部格式                            用户终端格式                                                                                
    主机操作系统  TELNET服务器端    TELNET协议      TELNET客户端    终端操作系统
    远程计算机系统                  NVT格式                         用户终端
    
## 7.4 电子邮件服务与 SMTP 协议
### 7.4.1 电子邮件服务的基本概念
    
    设备之间交换邮件信息
### 7.4.2 电子邮件服务的工作过程
1，电子邮件基本工作原理
    
    邮件客户端使用简单邮件传输协议(Simple Mail Transfer Protocol,SMTP)向邮件服务器发送邮件
    邮件客户端使用邮局协议(POP)的第3版POP3协议或交互式邮件存取协议(IMAP)从邮件服务器中接收邮件
2，SMTP邮件传输过程
    
    1，TCP连接建立：三次握手建立连接
    2，SMTP会话连接建立
    3，邮件发送
    4，SMTP 会话连接释放
    5，TCP连接释放：四次挥手过程
3，MIME协议的基本内容
    
    MIME使用网络虚拟终端(NVT)标准，允许非ASCII码数据通过SMTP传输
    
### 7.4.3 POP3、IMAP4 协议与基于 Web 的电子邮件
1，POP3协议
    
    POP3协议是目前最流行的邮件读取协议
    
    TCP连接建立
    POP3会话连接建立
    邮件事务处理
    释放POP3会话连接
    释放TCP连接
    
2，IMAP4协议
    
    IMAP4 是另一种邮件读取协议
    
    用户在下载邮件之间可以检查邮件的头部
    用户在下载邮件之前可以用特定的字符串搜索电子邮件的内容
    用户可以部分地下载电子邮件，这对于电子邮件中包含多媒体信息是很有用的
    用户可以在邮件服务器上创建、删除邮箱，或对邮箱改名，创建分层次的邮箱
3，基于Web的电子邮件
    
    基于Web的电子邮件应用中，客户代理就是Web浏览器，客户与远程邮箱之间的通信使用的是HTTP
## 7.5 Web 与基于Web的网络应用
### 7.5.1 Web 服务的基本概念
1，Web(World Wide Web)服务的核心技术
    
    超文本传送协议(HTTP)
    超文本标记语言(HTML)
    超链接(Hyperlink)
    统一资源定位符(URL)
2，主页的概念
    
    文本
    图像
    表格
    超链接
3，URL的基本概念
    
    URL，统一资源定位符
    http://www.nankai.edu.cn/index.html
    协议类型    主机名      路径及文件名
    
### 7.5.2 超文本传输协议
1，超文本传输协议(HTTP)的基本特点
    
    无状态协议
        HTTP协议在传输层使用TCP协议，Web服务器每次连接不保存Web浏览器任何信息
        
    非持续连接与持续连接
        非持续连接：服务器为客户发出的多个服务请求报文建立多个TCP连接进行应答的工作方式
        持续连接：多个客户与服务器的请求报文与应答报文都可以通过一个TCP连接来完成
    
    持续连接的两种方式：非流水线与流水线
        非流水线：客户端只有在接收到前一个响应时才能发出新的请求
        流水线：客户端在没有接收到前一个响应就才能发出新的请求
2，HTTP报文格式
    
    HTTP报文的基本概念
        HTTP是一种使用简单的请求报文与应答报文交互的协议
        
    HTTP请求报文结构
        请求报文：请求行(request line)，报头(header)，空白行(blank line)，正文(body)
        
        空白行用CR和LF表示，表示报头部分的结束
        请求行包括三个字段：方法，URL，HTTP版本
        
        方法(method)：表示浏览器发送给服务器的操作请求，服务器必须按照这些请求来为客户提供服务
        
    HTTP应答报文结构
        应答报文：状态行，报头，正文
        
        状态行：HTTP版本，状态码，状态短语
详情见图 7.20 请求报文的返送过程与结构
详情见图 7.21 HTTP应答报文结构及HTTP工作原理示意图
### 7.5.3 超文本标记语言
1，HTML常用的标记
2，Web文档类型
    
    静态文档：固定内容的文档。由服务器创建并保存在服务器
    动态文档：不存在预定义的格式，是在用户浏览器请求该文档时由服务器创建
    活动文档：存储应用程序等在用户请求时发给用户
    
### 7.5.4 Web 浏览器
    
    Web浏览器的功能是实现客户进程于指定URL的服务器进程的链接，发出请求报文，接收需要浏览的文档，
    向用户显示网页内容
### 7.5.5 搜索引擎
1，搜索引擎技术研究的背景
    
    目录导航式搜索引擎与网页搜索引擎
2，搜索引擎的基本工作原理与结构
    
    搜索引擎的基本工作原理
        标题，摘要，URL
    搜索引擎的结构
        搜索器
        索引器
        检索器
        用户接口
        
## 7.6 即时通信与会话初始化协议
### 7.6.1 及时通信工作模型
1，及时通信工作模型的类型
    
    在线的对等通信方式
    离线的中转通信方式
### 7.6.2 会话初始化协议的基本内容
1，及时通信协议的发展过程
    
    SIP(Session Initiation Protocol,初始化协议)是在应用层实现即时通信的控制信令协议
    SIP协议用于创建、修改和终止会话
    SIP协议在传输层可以使用TCP协议
2，会话初始化协议的特点
    
    协议简介，效率高
    客户/服务器工作模式
        用户代理
            用户代理客户：发起呼叫
            用户代理服务器：接受呼叫
        网络服务器
            代理服务器
            注册服务器
            重定向服务器：处理SIP呼叫路由
        代理服务器的两种状态
            有状态代理：可并行地建立和维护多个会话连接
            无状态代理：系统响应速度块
    地址灵活
3，SIP协议的报文格式
    
    SIP请求报文
    
SIP请求报文名称及意义
报文名称 | 意义
---|---
INVITE | 邀请用户或服务器参加一个会话，启动会话连接的建立
ACK | 用户或服务器同意参加一个会话，确认会话连接的建立
CANCEL | 取消即将发生的会话
BYE | 终止会话
INFO | 传送PSTN电话指令
OPTIONS | 查询一个服务器的能力
    
    SIP应答报文
SIP 应答报文状态码的范围及意义
状态码的范围 | 意义
---|---
100 ~ 199 | 临时的
200 ~ 299 | 成功 
300 ~ 399 | 重定向
400 ~ 499 | 客户端错误
500 ~ 599 | 服务器端错误
600 ~ 699 | 失败


4，SIP协议的工作过程

详情见图 7.28 SIP通过代理服务器建立会话连接的过程
## 7.7 主机配置与动态主机配置协议
### 7.7.1 动态主机配置的基本概念
    
    动态主机配置协议(DHCP)可以为主机自动分配IP地址及其他一些重要的参数
### 7.7.2 DHCP 的基本内容
1，DHCP服务器的主要功能
    
    地址储存与管理
    配置参数的储存和管理
    租用管理
    响应客户主机请求
    服务管理
    
2，DHCP客户的主要功能
    
    发起配置
    配置参数管理
    租用管理
    报文重传
3，DHCP客户与服务器的交互过程
    
            DHCP客户                                  DHCP服务器
                端口号：68                      端口号：67        
            -------1------------DHCPDISCOVER---------------->
                <----2------------DHCPOFFER--------------------
                -----3------------DHCPREQUEST----------------->
    租用定时器  <------4------------DHCPACK----------------------
    T1=0.5T     -----5------------DHCPREQUEST----------------->
                <----6------------DHCPACK---------------------
                                    .......
                -----7------------DHCPRELEASE----------------->              
            
    1：DHCP客户端需要按照DHCP协议构造一个IP租用请求DHCPDISCOVER请求报文，
        以广播方式发出去，客户进入初始化状态
    2：凡是接收到DHCP客户端请求报文的DHCP服务器都要返回一个DHCPOFFER应答报文。
        DHCPOFFER应答报文中包括有分配给DHCP客户端的IP地址，租用期及其他参数
    3：可能受到多个DHCPOFFER应答报文的DHCP客户端，从中选择一个DHCP服务器，然后
        向被选择的DHCP服务器发送一个DHCPREQUEST请求报文，作为对它所选择的服务的回应
    4：被选择的DHCP服务器向DHCP客户端发送一个DHCPACK应答报文。当DHCP客户端接收到
        DHCPACK应答报文之后，客户端才可以使用分配的临时IP地址，进入绑定状态
            
            
## 7.8 网络管理与简单网管协议
### 7.8.1 网络管理的基本概念
1，网络管理系统的组成
    
    网络管理的目的：网络资源能够得到有效的利用，网络出现故障时能及时报告和处理，以保证网络能够正常运行

    管理进程
    被管对象
    代理进程
    网络管理协议
        简单网络管理协议(SNMP),公共管理信息协议(CMIP)
    管理信息库(MIB)
2，网络管理功能
    
    配置管理
    性能管理
    记账管理
    故障管理
    安全管理
3，网络管理技术发展的过程
    
    网络管理系统体系结构与网络管理协议
    对协议名称中“简单”的理解
    
详情见图 7.32 SNMP协议的工作原理

### 7.8.2 SNMP 协议的基本内容
1，管理信息结构(SMI)
    
    对象命名树的结构
    
详情见图 7.33 SMI对象命名方法示意图

    MIB对象的定位
        常规MIB对象
        专用MIB对象
2，管理信息库(SMI)

目前使用的MIB(管理信息库)对象组
组名 | 完整的组标识符 | 包含的主要内容
---|---|---
system/sys | 1.3.6.1.2.1.1 | 与主机或路由器的操作系统相关的对象
interface/int | 1.3.6.1.2.1.2 | 与网络接口相关的对象
ip/ip | 1.3.6.1.2.1.4 | 与IP运行相关的对象
icmp/icmp | 1.3.6.1.2.1.5 | 与ICMP运行相关的对象
tcp/tcp | 1.3.6.1.2.1.6 | 与TCP运行相关的对象
udp/udp | 1.3.6.1.2.1.7 | 与UDP运行相关的对象
egp/egp | 1.3.6.1.2.1.8 | 与外部网关协议EGP运行相关的对象


3，SNMP的基本操作
    
    SNMP采用轮询的方式，周期性通过 读，写 操作来实现基本的网络管理功能。
    网络管理进程通过向代理进程发送Get报文检测悲观对象状态，使用Set报文来改变被管对象状态
## 7.9 典型应用层协议 -- FTP的分析
### 7.9.1 FTP 模型与测试环境分析
1，分析的基本方法
2，测试分析坏境
    
    实验室的局域网中模拟FTP服务的工作过程
    FTP Server  FTP Client
3，FTP工作模型
    
    FTP的工作经历三个阶段：连接建立，传输数据报文与连接释放
    FTP的连接分为 控制连接与数据连接
    
    通过DNS解析出服务器的IP地址，再根据IP地址通过ARP协议解析出对应的MAC地址，完成这两步后，
    进入TCP连接与FTP连接建立阶段

详情见图 7.37 FTP 工作模型示意图
详情见图 7.38 FTP client 与 Server交互的协议报文
    
### 7.9.2 FTP 控制连接建立过程的分析
1，连接建立准备阶段

2，FTP控制连接建立过程

### 7.9.3 FTP 用户登录与身份验证过程的分析
1，FTP Server准备接受新用户的服务请求

2，FTP 用户登录与身份验证

详情见图 7.43 FTP 用户登录与身份验证报文交互过程
### 7.9.4 FTP 数据连接建立过程的协议分析
1，数据连接建立准备过程
    
    数据连接建立前,Client 与 Server 之间的联系必须通过FTP控制连接来进行
2，数据连接建立过程
    
    数据连接由TCP协议完成，为FTP协议的数据传输服务
### 7.9.5 FTP 数据传输过程的分析
1，被检索文件状态报告与确认

2，检索文件数据的传输

### 7.9.6 FTP 用户退出登录过程的分析
    
    FTP Client                                                  FTP Server
    用户进程
    
    端口号：15432                                               端口号：21
                -----报文34：Client向Server发送QUIT命令报文-->
    FTP Client                                                  FTP Server
    控制进程                                                    控制进程
                <----报文35：Server向Client发送确认-------
### 7.9.7 FTP 连接释放过程的分析
    
    标准的TCP 连接释放要经过"四次握手"的过程，FTP连接释放也应该包括两个阶段，控制连接释放与数据连接释放
    首先是释放数据连接，然后释放控制连接
详情见图 7.54 FTP连接释放过程示意图

## 小结
    
    Web应用 P2P应用
    DNS域名解析
    TELNET 又称为 终端仿真协议
    电子邮件系统分为两个部分：
        邮件服务器端：使用邮局协议POP3(Post Office Protocol)或 
                    IMAP(Interactive Mail Access Protocol,交互式邮件存取协议)
                    从邮件服务其中接收邮件
        邮件客户端：使用SMTP(Simple Mail Transfer Protocol,简单邮件传输协议)
                    发送邮件到邮件服务器
    FTP(File Transfer Protocol,文件传输协议)需要在客户端与服务器之间
        建立控制连接与数据连接，以提高文件传输可靠性
    Web服务的核心技术：
        超文本传输协议，HTTP(Hyper Text Transfer Protocol)
        超文本标记语言，HTML(Hyper Text Markup Language)
        超链接，Hyperlink
        统一资源定位符，URL(Uniform Resource Locator)
    SIP(Session Initiation Protocol,初始化协议)是实现及时通信的控制信令协议
    动态主机配置协议 DHCP
    简单网络协议 SNMP(Simple Network Manger Protocol)
    